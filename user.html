<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <title>Green Company - 스마트 주문 시스템</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8fafc; color: #1e293b; }
        
        .category-btn.active {
            background-color: #4f46e5;
            color: white;
            box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.4);
        }

        .product-card { 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .product-card:hover { 
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05);
        }

        .img-container {
            position: relative;
            width: 100%;
            padding-top: 100%; /* 1:1 Aspect Ratio */
            overflow: hidden;
            border-radius: 1.25rem;
            background-color: #f1f5f9;
        }

        .img-container img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .product-card:hover img {
            transform: scale(1.1);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* 모달 애니메이션 */
        #optionModal { transition: all 0.3s ease; }
        .modal-enter { transform: scale(0.9) translateY(20px); opacity: 0; }
        .modal-show { transform: scale(1) translateY(0); opacity: 1; }
    </style>
</head>
<body class="pb-32">
    <!-- 헤더 섹션 -->
    <header class="bg-white/80 sticky top-0 z-50 backdrop-blur-xl border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 py-4">
            <div class="flex items-center justify-between gap-4">
                <div class="flex items-center gap-2 group cursor-pointer" onclick="location.reload()">
                    <div class="w-10 h-10 bg-gradient-to-br from-indigo-600 to-violet-600 rounded-xl flex items-center justify-center text-white shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3" />
                        </svg>
                    </div>
                    <span class="text-xl font-black text-slate-900 tracking-tight">그린컴퍼니</span>
                </div>

                <div class="flex-1 max-w-lg hidden md:block">
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="찾으시는 상품을 입력하세요" 
                            class="w-full bg-slate-100 border-transparent focus:bg-white focus:ring-2 focus:ring-indigo-500 rounded-2xl py-2.5 pl-11 pr-4 text-sm transition-all outline-none">
                        <svg class="absolute left-4 top-3 h-4 w-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                </div>

                <div id="cartStatus" class="flex items-center gap-2 bg-indigo-50 px-4 py-2 rounded-2xl text-indigo-600 font-bold text-sm border border-indigo-100">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                    </svg>
                    <span>주문 대기</span>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 pt-8">
        <!-- 카테고리 네비게이션 -->
        <div class="flex items-center gap-2 overflow-x-auto no-scrollbar mb-8 pb-2" id="categoryTabs">
            <button onclick="filterCategory('전체상품')" class="category-btn active px-6 py-2.5 rounded-full text-sm font-bold border border-slate-200 whitespace-nowrap transition-all">전체상품</button>
            <button onclick="filterCategory('과일')" class="category-btn px-6 py-2.5 rounded-full text-sm font-bold border border-slate-200 bg-white whitespace-nowrap transition-all">과일</button>
            <button onclick="filterCategory('야채')" class="category-btn px-6 py-2.5 rounded-full text-sm font-bold border border-slate-200 bg-white whitespace-nowrap transition-all">야채</button>
            <button onclick="filterCategory('농산물')" class="category-btn px-6 py-2.5 rounded-full text-sm font-bold border border-slate-200 bg-white whitespace-nowrap transition-all">농산물</button>
            <button onclick="filterCategory('수산물')" class="category-btn px-6 py-2.5 rounded-full text-sm font-bold border border-slate-200 bg-white whitespace-nowrap transition-all">수산물</button>
            <button onclick="filterCategory('기타 가공식품')" class="category-btn px-6 py-2.5 rounded-full text-sm font-bold border border-slate-200 bg-white whitespace-nowrap transition-all">기타 가공식품</button>
        </div>

        <!-- 상품 리스트 정보 -->
        <div class="flex items-center justify-between mb-6">
            <div>
                <h3 id="currentCategoryTitle" class="text-xl font-black text-slate-800">전체상품</h3>
                <p id="productCounter" class="text-xs font-medium text-slate-400 mt-1 italic">데이터를 불러오는 중...</p>
            </div>
            <div class="text-[10px] bg-slate-200 px-2 py-1 rounded text-slate-500 font-bold" id="syncStatus">CONNECTED</div>
        </div>

        <!-- 상품 그리드 -->
        <div id="productGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 sm:gap-6">
            <!-- 초기 로딩 스켈레톤 -->
            <div class="animate-pulse bg-white rounded-[2rem] h-64 border border-slate-100"></div>
            <div class="animate-pulse bg-white rounded-[2rem] h-64 border border-slate-100"></div>
            <div class="animate-pulse bg-white rounded-[2rem] h-64 border border-slate-100"></div>
            <div class="animate-pulse bg-white rounded-[2rem] h-64 border border-slate-100"></div>
        </div>
    </main>

    <!-- 옵션 선택 모달 -->
    <div id="optionModal" class="fixed inset-0 z-[100] hidden bg-slate-900/40 backdrop-blur-md flex items-center justify-center p-4">
        <div id="modalContent" class="bg-white w-full max-w-lg rounded-[2.5rem] overflow-hidden shadow-2xl modal-enter transition-all duration-300">
            <div id="modalBody" class="p-8"></div>
        </div>
    </div>

    <script>
        const SPREADSHEET_ID = '130QXnvHcdzyLPFBSAKbiSGsPVGMRkgmroViMiUuzrMU';
        const GID = '0';
        const CSV_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/export?format=csv&gid=${GID}`;

        let allProducts = [];
        let groupedData = {};

        // [핵심 로직] 키워드 기반 이미지 매칭 라이브러리
        const IMAGE_MAP = {
            '사과': 'apple', '배': 'pear', '포도': 'grape', '딸기': 'strawberry', '수박': 'watermelon', 
            '참외': 'melon', '복숭아': 'peach', '바나나': 'banana', '오렌지': 'orange', '토마토': 'tomato',
            '배추': 'napa-cabbage', '무': 'radish', '오이': 'cucumber', '호박': 'pumpkin', '당근': 'carrot',
            '마늘': 'garlic', '양파': 'onion', '고추': 'chili', '상추': 'lettuce', '버섯': 'mushroom',
            '고등어': 'mackerel', '갈치': 'hairtail', '오징어': 'squid', '새우': 'shrimp', '전복': 'abalone',
            '조기': 'corvina', '멸치': 'anchovy', '김': 'seaweed', '계란': 'egg', '두부': 'tofu',
            '쌀': 'rice', '콩': 'bean', '감자': 'potato', '고구마': 'sweet-potato', '옥수수': 'corn'
        };

        function getRepresentativeImage(name) {
            let keyword = 'vegetables'; // 기본값
            for (const key in IMAGE_MAP) {
                if (name.includes(key)) {
                    keyword = IMAGE_MAP[key];
                    break;
                }
            }
            
            // Unsplash Source API 활용 (키워드 매칭)
            return `https://source.unsplash.com/featured/800x800/?${keyword},food,fresh`;
        }

        function parseCSV(text) {
            const rows = [];
            const lines = text.split(/\r?\n/);
            lines.forEach(line => {
                const values = [];
                let current = "";
                let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') inQuotes = !inQuotes;
                    else if (char === ',' && !inQuotes) {
                        values.push(current.trim());
                        current = "";
                    } else current += char;
                }
                values.push(current.trim());
                rows.push(values);
            });
            return rows;
        }

        async function initData() {
            try {
                const response = await fetch(CSV_URL);
                const data = await response.text();
                const rows = parseCSV(data).slice(1); // 헤더 제외

                const tempGrouped = {};

                rows.forEach(cols => {
                    const rawName = cols[3] || cols[2] || "";
                    if (!rawName) return;

                    // 그룹화 키 생성 (괄호 이전 이름 추출)
                    const groupKey = rawName.split('(')[0].replace(/[0-9]/g, '').trim();
                    const price = parseInt(cols[4]?.replace(/[^0-9]/g, '') || "0");
                    if (price === 0) return;

                    // 판매가 계산 (공급가 + 20% 마진)
                    const sellingPrice = Math.ceil((price * 1.2) / 100) * 100;

                    // 카테고리 자동 판별
                    let category = "기타 가공식품";
                    const fruitKeys = ['사과','배','포도','딸기','수박','참외','복숭아','귤','오렌지'];
                    const vegeKeys = ['배추','무','오이','상추','깻잎','고추','파','마늘','양파'];
                    const seaKeys = ['고등어','갈치','오징어','새우','조개','멸치','전복'];
                    const agriKeys = ['쌀','잡곡','감자','고구마','콩','옥수수'];

                    if (fruitKeys.some(k => groupKey.includes(k))) category = "과일";
                    else if (vegeKeys.some(k => groupKey.includes(k))) category = "야채";
                    else if (seaKeys.some(k => groupKey.includes(k))) category = "수산물";
                    else if (agriKeys.some(k => groupKey.includes(k))) category = "농산물";

                    if (!tempGrouped[groupKey]) {
                        tempGrouped[groupKey] = {
                            name: groupKey,
                            category: category,
                            image: getRepresentativeImage(groupKey),
                            options: []
                        };
                    }

                    tempGrouped[groupKey].options.push({
                        fullName: rawName,
                        spec: cols[5] || "규격 별도문의",
                        price: sellingPrice
                    });
                });

                allProducts = Object.values(tempGrouped);
                renderGrid(allProducts);
                document.getElementById('syncStatus').innerText = `최종 동기화: ${new Date().toLocaleTimeString()}`;
            } catch (err) {
                console.error(err);
                document.getElementById('productCounter').innerText = "데이터 연결 실패";
            }
        }

        function renderGrid(products) {
            const grid = document.getElementById('productGrid');
            document.getElementById('productCounter').innerText = `${products.length}개의 품목 진열 중`;
            
            if (products.length === 0) {
                grid.innerHTML = `<div class="col-span-full py-20 text-center text-slate-400 font-bold">검색 결과가 없습니다.</div>`;
                return;
            }

            grid.innerHTML = products.map(item => {
                const minPrice = Math.min(...item.options.map(o => o.price));
                return `
                <div onclick="openModal('${item.name}')" class="product-card bg-white rounded-[2rem] p-4 border border-slate-100 flex flex-col cursor-pointer">
                    <div class="img-container mb-4">
                        <img src="${item.image}" alt="${item.name}" loading="lazy" 
                             onerror="this.src='https://source.unsplash.com/featured/800x800/?fresh,food'">
                        <div class="absolute top-3 left-3 bg-white/90 backdrop-blur px-2 py-1 rounded-lg text-[10px] font-black text-indigo-600 shadow-sm border border-white">
                            ${item.category}
                        </div>
                    </div>
                    <div class="flex-1 px-1">
                        <h4 class="font-bold text-slate-800 text-sm leading-snug line-clamp-2 min-h-[2.5rem] mb-2">${item.name}</h4>
                        <div class="flex items-end justify-between">
                            <span class="text-[10px] text-slate-400 font-bold uppercase">최저가</span>
                            <span class="text-base font-black text-indigo-600">${minPrice.toLocaleString()}원~</span>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function filterCategory(cat) {
            // UI 업데이트
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.innerText === cat) btn.classList.add('active');
            });
            document.getElementById('currentCategoryTitle').innerText = cat;

            // 데이터 필터링
            if (cat === '전체상품') {
                renderGrid(allProducts);
            } else {
                const filtered = allProducts.filter(p => p.category === cat);
                renderGrid(filtered);
            }
        }

        function openModal(name) {
            const product = allProducts.find(p => p.name === name);
            const modal = document.getElementById('optionModal');
            const content = document.getElementById('modalContent');
            const body = document.getElementById('modalBody');

            body.innerHTML = `
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 rounded-2xl overflow-hidden shadow-inner">
                            <img src="${product.image}" class="w-full h-full object-cover">
                        </div>
                        <div>
                            <span class="text-[10px] font-bold text-indigo-500">${product.category}</span>
                            <h2 class="text-xl font-black text-slate-900">${product.name}</h2>
                        </div>
                    </div>
                    <button onclick="closeModal()" class="p-2 hover:bg-slate-100 rounded-full transition-colors">
                        <svg class="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <div class="space-y-3 max-h-[40vh] overflow-y-auto no-scrollbar pr-1">
                    ${product.options.map(opt => `
                        <div class="p-4 rounded-2xl border border-slate-100 hover:border-indigo-500 hover:bg-indigo-50/30 transition-all cursor-pointer group">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h5 class="text-sm font-bold text-slate-800">${opt.fullName}</h5>
                                    <p class="text-[10px] text-slate-400 mt-1">${opt.spec}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-base font-black text-indigo-600">${opt.price.toLocaleString()}원</p>
                                    <p class="text-[9px] text-slate-300 font-bold uppercase mt-0.5">VAT 포함</p>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>

                <button class="w-full mt-8 py-5 bg-slate-900 text-white rounded-[1.5rem] font-black text-sm hover:bg-indigo-600 transition-all shadow-xl active:scale-95">
                    선택한 품목 발주하기
                </button>
            `;

            modal.classList.remove('hidden');
            setTimeout(() => { content.classList.add('modal-show'); }, 10);
        }

        function closeModal() {
            const modal = document.getElementById('optionModal');
            const content = document.getElementById('modalContent');
            content.classList.remove('modal-show');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
        }

        // 검색 이벤트
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = allProducts.filter(p => 
                p.name.toLowerCase().includes(term) || 
                p.category.toLowerCase().includes(term)
            );
            renderGrid(filtered);
        });

        window.onload = initData;
    </script>
</body>
</html>